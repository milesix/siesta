Preparing Wannier90 for SIESTA calculations
===========================================


Motivations
-----------

Wannier90 is mostly meant to be used as a standalone program, reading its
parameters from input files and writing results to output files. In these
conditions, performing a wannierisation with SIESTA would mean prepare the
input data, interrupt the SIESTA calculation, run Wannier90 for each manifold
of interest, and then continue with the SIESTA calculation. Such a procedure
would invlove several manual steps, which would make it particularly
error-prone.

In order to streamline the whole process and have Wannier90 run embedded in
SIESTA, it is necessary to build a modified version of its source code. These
changes allow Wannier90 to receive its input directly from SIESTA and to be
run several times with different input parameters without having to stop the
program. They have been kept minimalistic, in order not to interfere with the
internals of Wannier90 and make it easier to keep SIESTA synchronised with the
evolution of the source code.


Building a modified Wannier90
-----------------------------

A) With CMake

   Just define the WANNIER90_PACKAGE environment variable to point to
   a pristine wannier90-3.1.0.tar.gz package (possibly remote):

   export WANNIER90_PACKAGE=/path/to/wannier90-3.1.0.tar.gz
   export WANNIER90_PACKAGE=https://github.com/wannier-developers/wannier90/archive/v3.1.0.tar.gz

   and set -DWITH_WANNIER90=ON in the CMake invocation line for Siesta. The build system will
   unpack and patch the wannier90 distribution automatically, and compile the appropriate version
   (serial or mpi) of the library.

B) With the makefile-based build system

In this directory you will find the required patches for a specific Wannier90
version.

The next step is to download an official release tarball from the Wannier90
website:

  http://www.wannier.org/download/

The version to download must correspond exactly to the version of the patch
you want to apply. For instance, if the patch is called
"wannier90-3.0.0.patch", you have to download the 3.0.0 version of
Wannier90. Applying the patch to other versions will likely fail. We will use
this version as an example for the rest of these instructions.

Uncompress the source code of Wannier90 and go to its top directory, e.g.:

  tar xvzf wannier90-3.0.0.tar.gz
  cd wannier90-3.0.0

From there, you can apply the patch from SIESTA:

  patch -p1 < /path/to/siesta/Util/Wannier90/wannier90-3.0.0.patch

where you replace /path/to/siesta/Util/Wannier90 by the directory path
containing the patch file.

Once done, you can follow the instructions found in the README.install file of
Wannier90 to configure the build. You should then type "make lib" to build the
Wannier90 library, which is the only part of interest to SIESTA.
If SIESTA is compiled with MPI, so should Wannier90.


Using a modified Wannier90 from SIESTA
--------------------------------------

To use the Wannier90 library you just have built with SIESTA:

- Add 'WITH_WANNIER90=1' to your arch.make
- Set WANNIER90_ROOT to point to an installation of WANNIER90
- (... but make sure that you have the .mod files in the include/
   subdirectory and the .a file in the lib/ subdirectory)
   You can achieve this by

   cd $WANNIER90_ROOT
   mkdir lib
   cp libwannier.a lib
   mkdir include
   ln -sf $(pwd)/src/obj $(pwd)/include

Once done, you can proceed as usual with the build of SIESTA.
